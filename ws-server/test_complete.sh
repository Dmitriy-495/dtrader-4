#!/bin/bash

echo "üß™ –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ WebSocket —Å–µ—Ä–≤–µ—Ä–∞"
echo "======================================"
echo ""

# –£–±–∏–≤–∞–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
PID=$(lsof -ti :2808)
if [ ! -z "$PID" ]; then
    echo "üî¥ –ù–∞—à–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ –ø–æ—Ä—Ç—É 2808: $PID"
    kill -9 $PID
    sleep 1
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
echo "üöÄ –ó–∞–ø—É—Å–∫ WebSocket —Å–µ—Ä–≤–µ—Ä–∞..."
cd /home/tda/code/dtrader/dtrader-4/ws-server
node dist/app.js &
SERVER_PID=$!
echo "üìù PID —Å–µ—Ä–≤–µ—Ä–∞: $SERVER_PID"

# –ñ–¥—ë–º –∑–∞–ø—É—Å–∫–∞
sleep 2

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
if ! ps -p $SERVER_PID > /dev/null; then
    echo "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
    exit 1
fi

echo "‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
echo ""

# –¢–µ—Å—Ç–∏—Ä—É–µ–º JavaScript –∫–ª–∏–µ–Ω—Ç
echo "üì± –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ JavaScript –∫–ª–∏–µ–Ω—Ç–∞..."
node test_welcome_client.js
if [ $? -eq 0 ]; then
    echo "‚úÖ JavaScript –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—à—ë–ª —Ç–µ—Å—Ç"
else
    echo "‚ùå JavaScript –∫–ª–∏–µ–Ω—Ç –Ω–µ –ø—Ä–æ—à—ë–ª —Ç–µ—Å—Ç"
    kill -9 $SERVER_PID
    exit 1
fi
echo ""

# –¢–µ—Å—Ç–∏—Ä—É–µ–º Python –∫–ª–∏–µ–Ω—Ç
echo "üêç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Python –∫–ª–∏–µ–Ω—Ç–∞..."
python3 test_welcome_python.py
if [ $? -eq 0 ]; then
    echo "‚úÖ Python –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—à—ë–ª —Ç–µ—Å—Ç"
else
    echo "‚ùå Python –∫–ª–∏–µ–Ω—Ç –Ω–µ –ø—Ä–æ—à—ë–ª —Ç–µ—Å—Ç"
    kill -9 $SERVER_PID
    exit 1
fi
echo ""

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
echo "üõë –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è..."
kill -TERM $SERVER_PID
sleep 2

if ps -p $SERVER_PID > /dev/null; then
    echo "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è"
    kill -9 $SERVER_PID
    exit 1
fi

echo "‚úÖ –°–µ—Ä–≤–µ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–æ—Ä—Ç–∞
if lsof -i :2808 > /dev/null; then
    echo "‚ùå –ü–æ—Ä—Ç 2808 –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω"
    exit 1
fi

echo "‚úÖ –ü–æ—Ä—Ç 2808 –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω"
echo ""

echo "üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
echo ""
echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:"
echo "   ‚úÖ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞"
echo "   ‚úÖ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (JavaScript)"
echo "   ‚úÖ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (Python)"
echo "   ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ"
echo "   ‚úÖ –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤"
echo ""
echo "üí° –°–µ—Ä–≤–µ—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!"