#!/bin/bash

echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–∫–∏ –∑–∞–Ω—è—Ç–æ–≥–æ –ø–æ—Ä—Ç–∞"
echo "=============================================="
echo ""

# –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç 2808
PID=$(lsof -ti :2808 2>/dev/null)
if [ ! -z "$PID" ]; then
    echo "üî¥ –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç 2808..."
    kill -9 $PID
    sleep 1
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–π–º—ë—Ç –ø–æ—Ä—Ç 2808
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–π–º—ë—Ç –ø–æ—Ä—Ç 2808..."
cd /home/tda/code/dtrader/dtrader-4/ws-server
node -e "const http = require('http'); http.createServer().listen(2808);" &
BLOCKER_PID=$!
sleep 1

echo "‚úÖ –ü–æ—Ä—Ç 2808 –∑–∞–Ω—è—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ–º $BLOCKER_PID"
echo ""

# –ü—Ä–æ–±—É–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å WebSocket —Å–µ—Ä–≤–µ—Ä (–¥–æ–ª–∂–µ–Ω –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è —Å –æ—à–∏–±–∫–æ–π)
echo "üöÄ –ü—Ä–æ–±—É–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å WebSocket —Å–µ—Ä–≤–µ—Ä..."
if node dist/app.js 2>&1 | head -20 | grep -q "üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ü–æ—Ä—Ç —É–∂–µ –∑–∞–Ω—è—Ç!"; then
    echo ""
    echo "‚úÖ –£–°–ü–ï–•: –°–µ—Ä–≤–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –ø—Ä–∏ –∑–∞–Ω—è—Ç–æ–º –ø–æ—Ä—Ç–µ!"
    echo "   –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ª–æ–≥–∏ –æ–± –æ—à–∏–±–∫–µ."
else
    echo ""
    echo "‚ùå –û–®–ò–ë–ö–ê: –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –ø—Ä–∏ –∑–∞–Ω—è—Ç–æ–º –ø–æ—Ä—Ç–µ!"
    kill -9 $BLOCKER_PID
    exit 1
fi

# –£–±–∏–≤–∞–µ–º –±–ª–æ–∫–∏—Ä—É—é—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å
kill -9 $BLOCKER_PID

echo ""
echo "üéâ –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
echo "   –°–µ—Ä–≤–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É –∑–∞–Ω—è—Ç–æ–≥–æ –ø–æ—Ä—Ç–∞."