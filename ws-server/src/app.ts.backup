// DTrader WebSocket Server Instance - Instance D
// –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞–º

import { WebSocketServer, WebSocket } from "ws";
import { createClient, RedisClientType } from "redis";
import dotenv from "dotenv";
import { baseConfig as config } from "./config/config";

dotenv.config();

interface ClientInfo {
  id: string;
  ws: WebSocket;
  isAlive: boolean;
  connectedAt: number;
  subscriptions: {
    exchanges: Set<string>;
    events: Set<string>;
  };
}

interface SystemStatus {
  timestamp: number;
  botStatus: "idle" | "running" | "error";
  traderStatus: "idle" | "running" | "error";
  redisConnected: boolean;
  lastTradeSignal?: string;
}

class WebSocketServerInstance {
  private wss?: WebSocketServer;
  private redisClient: RedisClientType;
  private clients: Map<string, ClientInfo>;
  private pingInterval: NodeJS.Timeout | null;
  private systemStatus: SystemStatus;
  private exchangeBalance: any | null;
  private isRunning: boolean;
  private isShuttingDown: boolean;

  constructor() {
    this.isShuttingDown = false;
    this.exchangeBalance = null;
    this.clients = new Map();
    this.pingInterval = null;
    this.isRunning = false;

    this.systemStatus = {
      timestamp: Date.now(),
      botStatus: "idle",
      traderStatus: "idle",
      redisConnected: false,
    };

    if (!config.redis) {
      throw new Error("Redis configuration is required for WebSocket Server");
    }

    this.redisClient = createClient({
      url: `redis://${config.redis.host}:${config.redis.port}`,
    });
  }

  async initialize() {
    try {
      // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Redis
      await this.redisClient.connect();
      this.systemStatus.redisConnected = true;

      console.log(
        `‚úÖ [${new Date().toISOString()}] WebSocket Server Instance D –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω`
      );
      console.log(
        `   üîå [${new Date().toISOString()}] –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Redis: redis://${
          config.redis.host
        }:${config.redis.port}`
      );

      // –°–æ–∑–¥–∞–µ–º WebSocket —Å–µ—Ä–≤–µ—Ä
      try {
        this.wss = new WebSocketServer({ port: config.WS_PORT });
        console.log(
          `üì° [${new Date().toISOString()}] WebSocket —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ ws://localhost:${
            config.WS_PORT
          }`
        );
      } catch (error) {
        const errorMessage =
          error instanceof Error ? error.message : String(error);
        console.error(
          `‚ùå [${new Date().toISOString()}] –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å WebSocket —Å–µ—Ä–≤–µ—Ä:`,
          errorMessage
        );
        console.error(
          `   [${new Date().toISOString()}] –ü–æ—Ä—Ç —É–∂–µ –∑–∞–Ω—è—Ç –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω`
        );
        process.exit(1); // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
      }

      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      this.setupWebSocketHandlers();

      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º ping-pong
      this.setupPingPong();

      // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è
      await this.subscribeToEvents();

      this.isRunning = true;
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ WebSocket Server:`,
        error
      );
      throw error;
    }
  }

  private setupWebSocketHandlers() {
    if (!this.wss) return;

    this.wss.on("connection", (ws: WebSocket) => {
      this.handleNewConnection(ws);
    });

    this.wss.on("error", (error: unknown) => {
      const errorMessage =
        error instanceof Error ? error.message : String(error);
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ WebSocket —Å–µ—Ä–≤–µ—Ä–∞:`,
        errorMessage
      );
      if (errorMessage.includes("EADDRINUSE")) {
        console.error(
          `üí• [${new Date().toISOString()}] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ü–æ—Ä—Ç —É–∂–µ –∑–∞–Ω—è—Ç!`
        );
        console.error(
          `   [${new Date().toISOString()}] –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É —Å–µ—Ä–≤–µ—Ä–∞...`
        );
        process.exit(1);
      }
    });
  }

  private handleNewConnection(ws: WebSocket) {
    try {
      const clientId = this.generateClientId();

      const clientInfo: ClientInfo = {
        id: clientId,
        ws,
        isAlive: true,
        connectedAt: Date.now(),
        subscriptions: {
          exchanges: new Set<string>(),
          events: new Set<string>(),
        },
      };

      this.clients.set(clientId, clientInfo);

      console.log(
        `üîå [${new Date().toISOString()}] –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω: ${clientId} (–≤—Å–µ–≥–æ: ${
          this.clients.size
        })`
      );

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      this.sendWelcomeMessage(ws, clientId);

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
      if (this.exchangeBalance) {
        this.sendBalanceToClient(ws, clientId, this.exchangeBalance);
      }

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
      this.sendCurrentSystemStatus(ws);

      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      ws.on("message", (message: string) => {
        this.handleClientMessage(clientId, message);
      });

      ws.on("pong", () => {
        this.handleClientPong(clientId);
      });

      ws.on("close", () => {
        this.handleClientDisconnect(clientId);
      });

      ws.on("error", (error: Error) => {
        console.error(
          `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ ${clientId}:`,
          error.message
        );
        this.handleClientDisconnect(clientId);
      });
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:`,
        error
      );
    }
  }

  private generateClientId(): string {
    return `CLIENT-${Date.now()}-${Math.floor(Math.random() * 10000)}`;
  }

  private sendWelcomeMessage(ws: WebSocket, clientId: string) {
    try {
      const message = {
        type: "system:welcome",
        clientId,
        timestamp: Date.now(),
        message: "üéâ Welcome to DTrader WebSocket Server Instance D!",
        serverInfo: {
          version: "1.0.0",
          instance: "D",
          protocolVersion: "2.0",
          nodeEnv: config.NODE_ENV,
          uptime: process.uptime(),
        },
        connectionInfo: {
          clientId,
          connectedAt: Date.now(),
          serverTime: new Date().toISOString(),
          websocketPort: config.WS_PORT,
        },
        systemStatus: {
          redisConnected: this.systemStatus.redisConnected,
          botStatus: this.systemStatus.botStatus,
          traderStatus: this.systemStatus.traderStatus,
          lastTradeSignal: this.systemStatus.lastTradeSignal || "None",
        },
        availableEvents: [
          "system:status",
          "trade:signal",
          "trade:executed",
          "trade:error",
          "market:update",
          "ping",
          "pong",
          "exchange:pong",
          "bot:pingpong",
          "exchange:balance",
        ],
        availableCommands: {
          subscribe: "Subscribe to specific events",
          unsubscribe: "Unsubscribe from events",
          status: "Get current system status",
          help: "Get help information",
        },
        documentation: {
          api: "https://dtrader.example.com/api-docs",
          github: "https://github.com/dtrader-team/dtrader",
          support: "support@dtrader.example.com",
        },
        tips: [
          'Use {"type":"ping"} to check connection health',
          'Send {"type":"status"} to get current system status',
          "All messages must be valid JSON",
          "Maximum message size: 16KB",
        ],
      };

      ws.send(JSON.stringify(message, null, 2));
      console.log(
        `üì© [${new Date().toISOString()}] –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç—É ${clientId}`
      );
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:`,
        error
      );
    }
  }

  private sendCurrentSystemStatus(ws: WebSocket) {
    try {
      const message = {
        type: "system:status",
        data: this.systemStatus,
        timestamp: Date.now(),
      };

      ws.send(JSON.stringify(message));
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã:`,
        error
      );
    }
  }

  private handleClientMessage(clientId: string, message: string) {
    try {
      const client = this.clients.get(clientId);
      if (!client) return;

      console.log(
        `üì© [${new Date().toISOString()}] –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ ${clientId}:`,
        message
      );
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞:`,
        error
      );
    }
  }

  private handleClientPong(clientId: string) {
    try {
      const client = this.clients.get(clientId);
      if (!client) return;

      client.isAlive = true;
      console.log(
        `üèì [${new Date().toISOString()}] PONG –ø–æ–ª—É—á–µ–Ω –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ ${clientId}`
      );
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ pong –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞:`,
        error
      );
    }
  }

  private handleClientDisconnect(clientId: string) {
    try {
      this.clients.delete(clientId);
      console.log(
        `üîå [${new Date().toISOString()}] –ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–ª—é—á–µ–Ω: ${clientId} (–æ—Å—Ç–∞–ª–æ—Å—å: ${
          this.clients.size
        })`
      );
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞:`,
        error
      );
    }
  }

  private setupPingPong() {
    const pingIntervalMs = 15000;

    this.pingInterval = setInterval(() => {
      this.sendPingToAllClients();
    }, pingIntervalMs);

    console.log(
      `üîÑ [${new Date().toISOString()}] Ping-Pong –º–µ—Ö–∞–Ω–∏–∑–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–∏–Ω—Ç–µ—Ä–≤–∞–ª: ${pingIntervalMs}ms)`
    );
  }

  /**
   * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –Ω–æ–≤–æ–º—É –∫–ª–∏–µ–Ω—Ç—É
   * @param ws WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
   * @param clientId ID –∫–ª–∏–µ–Ω—Ç–∞
   * @param balanceData –î–∞–Ω–Ω—ã–µ –±–∞–ª–∞–Ω—Å–∞
   */
  private sendBalanceToClient(
    ws: WebSocket,
    clientId: string,
    balanceData: any
  ) {
    try {
      const message = {
        type: "exchange:balance",
        exchange: balanceData.exchange || "unknown",
        data: balanceData,
        timestamp: Date.now(),
        source: "exchange",
      };

      ws.send(JSON.stringify(message));
      console.log(
        `üí∞ [${new Date().toISOString()}] –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–æ–≤–æ–º—É –∫–ª–∏–µ–Ω—Ç—É ${clientId}`
      );
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–∞–ª–∞–Ω—Å–∞ –∫–ª–∏–µ–Ω—Ç—É ${clientId}:`,
        error
      );
    }
  }

  private sendPingToAllClients() {
    try {
      this.clients.forEach((client, clientId) => {
        if (client.isAlive === false) {
          console.log(
            `‚ö†Ô∏è  [${new Date().toISOString()}] –ö–ª–∏–µ–Ω—Ç ${clientId} –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ`
          );
          client.ws.terminate();
          return;
        }

        client.isAlive = false;

        try {
          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ—Ç–æ–∫–æ–ª—å–Ω—ã–π PING —Ñ—Ä–µ–π–º –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
          client.ws.ping();
          console.log(
            `üèì [${new Date().toISOString()}] PING –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É ${clientId}`
          );
        } catch (error) {
          console.error(
            `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ping –∫–ª–∏–µ–Ω—Ç—É ${clientId}:`,
            error
          );
          client.ws.terminate();
        }
      });
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ping –∫–ª–∏–µ–Ω—Ç–∞–º:`,
        error
      );
    }
  }

  private async subscribeToEvents() {
    try {
      console.log(
        `üì° [${new Date().toISOString()}] –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –æ—Ç –¥—Ä—É–≥–∏—Ö –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤...`
      );

      // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –æ—Ç –±–æ—Ç–∞
      await this.redisClient.subscribe("bot:events", (message) => {
        this.handleBotEvent(message);
      });

      // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è
      await this.redisClient.subscribe("execution:results", (message) => {
        this.handleExecutionEvent(message);
      });

      // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
      await this.redisClient.subscribe("state:updates", (message) => {
        this.handleStateUpdate(message);
      });

      // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ pong —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–∏—Ä–∂–∏
      await this.redisClient.subscribe("exchange:pong", (message) => {
        console.log(
          `üì© [${new Date().toISOString()}] –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ –∏–∑ Redis (exchange:pong): ${message}`
        );
        this.handleExchangePong(message);
      });

      // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ ping-pong —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞
      await this.redisClient.subscribe("bot:pingpong", (message) => {
        this.handleBotPingPong(message);
      });

      // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –±–∞–ª–∞–Ω—Å–µ –æ—Ç –±–∏—Ä–∂–∏
      await this.redisClient.subscribe("exchange:balance", (message) => {
        this.handleExchangeBalance(message);
      });

      console.log(
        `‚úÖ [${new Date().toISOString()}] –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –∞–∫—Ç–∏–≤–Ω–∞`
      );
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è:`,
        error
      );
    }
  }

  private handleBotEvent(message: string) {
    try {
      const event = JSON.parse(message);
      console.log(
        `ü§ñ [${new Date().toISOString()}] –°–æ–±—ã—Ç–∏–µ –æ—Ç –±–æ—Ç–∞: ${event.type}`
      );

      this.broadcastToAllClients("bot:event", event);
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏—è –æ—Ç –±–æ—Ç–∞:`,
        error
      );
    }
  }

  private handleExecutionEvent(message: string) {
    try {
      const event = JSON.parse(message);
      console.log(
        `üí∞ [${new Date().toISOString()}] –°–æ–±—ã—Ç–∏–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è: ${event.type}`
      );

      this.broadcastToAllClients("execution:event", event);
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è:`,
        error
      );
    }
  }

  private handleStateUpdate(message: string) {
    try {
      const event = JSON.parse(message);
      console.log(
        `üîÑ [${new Date().toISOString()}] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è: ${event.type}`
      );

      this.broadcastToAllClients("state:update", event);
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è:`,
        error
      );
    }
  }

  /**
   * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç ping-pong —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞
   * @param message –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç Redis
   */
  private handleBotPingPong(message: string) {
    try {
      const pingPongData = JSON.parse(message);

      // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞
      const messageType = pingPongData.type === "ping" ? "PING" : "PONG";
      console.log(
        `ü§ñ [${new Date().toISOString()}] –ü–æ–ª—É—á–µ–Ω–æ ${messageType} –æ—Ç –±–æ—Ç–∞`
      );
      console.log(
        `   üìä [${new Date().toISOString()}] –ó–∞–¥–µ—Ä–∂–∫–∞: ${
          pingPongData.latency || "N/A"
        }ms`
      );
      console.log(
        `   üïí [${new Date().toISOString()}] –í—Ä–µ–º—è: ${
          pingPongData.timestamp
            ? new Date(pingPongData.timestamp).toISOString()
            : "N/A"
        }`
      );

      // –¢—Ä–∞–Ω—Å–ª–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º
      this.broadcastBotPingPong(pingPongData);
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ping-pong –æ—Ç –±–æ—Ç–∞:`,
        error
      );
      console.log(`üìÑ [${new Date().toISOString()}] –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ: ${message}`);
    }
  }

  /**
   * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç pong —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–∏—Ä–∂–∏
   * @param message –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç Redis
   */
  private handleExchangePong(message: string) {
    try {
      const pongData = JSON.parse(message);

      // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ pong –æ—Ç –±–∏—Ä–∂–∏
      console.log(
        `üèì [${new Date().toISOString()}] –ü–æ–ª—É—á–µ–Ω–æ pong –æ—Ç –±–∏—Ä–∂–∏ ${
          pongData.exchange || "unknown"
        }`
      );
      console.log(
        `   üìä [${new Date().toISOString()}] –ó–∞–¥–µ—Ä–∂–∫–∞: ${
          pongData.latency || "N/A"
        }ms`
      );
      console.log(
        `   üïí [${new Date().toISOString()}] –í—Ä–µ–º—è: ${
          pongData.timestamp
            ? new Date(pongData.timestamp).toISOString()
            : "N/A"
        }`
      );

      // –¢—Ä–∞–Ω—Å–ª–∏—Ä—É–µ–º pong –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º
      this.broadcastExchangePong(pongData.exchange || "unknown", pongData);
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ pong –æ—Ç –±–∏—Ä–∂–∏:`,
        error
      );
      console.log(`üìÑ [${new Date().toISOString()}] –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ: ${message}`);
    }
  }

  /**
   * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ –±–∞–ª–∞–Ω—Å–µ –æ—Ç –±–∏—Ä–∂–∏
   * @param message –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç Redis
   */
  private handleExchangeBalance(message: string) {
    try {
      const balanceData = JSON.parse(message);

      // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –æ—Ç –±–∏—Ä–∂–∏
      console.log(
        `üí∞ [${new Date().toISOString()}] –ü–æ–ª—É—á–µ–Ω –±–∞–ª–∞–Ω—Å –æ—Ç –±–∏—Ä–∂–∏ ${
          balanceData.exchange || "unknown"
        }`
      );
      console.log(
        `   ü™ô [${new Date().toISOString()}] –ë–∞–ª–∞–Ω—Å: ${
          balanceData.balance || "N/A"
        }`
      );
      console.log(
        `   üïí [${new Date().toISOString()}] –í—Ä–µ–º—è: ${
          balanceData.timestamp
            ? new Date(balanceData.timestamp).toISOString()
            : "N/A"
        }`
      );

      // –¢—Ä–∞–Ω—Å–ª–∏—Ä—É–µ–º –±–∞–ª–∞–Ω—Å –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º
      this.broadcastExchangeBalance(balanceData);
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–∞–ª–∞–Ω—Å–∞ –æ—Ç –±–∏—Ä–∂–∏:`,
        error
      );
      console.log(`üìÑ [${new Date().toISOString()}] –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ: ${message}`);
    }
  }

  /**
   * –¢—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç ping-pong —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞ –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º
   * @param pingPongData –î–∞–Ω–Ω—ã–µ ping-pong —Å–æ–æ–±—â–µ–Ω–∏—è
   */
  private broadcastBotPingPong(pingPongData: any) {
    try {
      const message = {
        type: "bot:pingpong",
        data: pingPongData,
        timestamp: Date.now(),
        source: "bot",
      };

      const messageString = JSON.stringify(message);

      console.log(
        `üì° [${new Date().toISOString()}] –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è ${
          pingPongData.type
        } –æ—Ç –±–æ—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞–º...`
      );

      this.clients.forEach((client, clientId) => {
        if (client.ws.readyState === 1) {
          try {
            client.ws.send(messageString);
            console.log(
              `üì§ [${new Date().toISOString()}] ${
                pingPongData.type
              } –æ—Ç –±–æ—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É ${clientId}`
            );
          } catch (error) {
            console.error(
              `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ${
                pingPongData.type
              } –∫–ª–∏–µ–Ω—Ç—É ${clientId}:`,
              error
            );
          }
        }
      });

      console.log(
        `‚úÖ [${new Date().toISOString()}] ${
          pingPongData.type
        } –æ—Ç –±–æ—Ç–∞ —Ç—Ä–∞–Ω—Å–ª–∏—Ä–æ–≤–∞–Ω ${this.clients.size} –∫–ª–∏–µ–Ω—Ç–∞–º`
      );
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ ping-pong –æ—Ç –±–æ—Ç–∞:`,
        error
      );
    }
  }

  private broadcastToAllClients(type: string, data: any) {
    try {
      const message = {
        type,
        data,
        timestamp: Date.now(),
      };

      const messageString = JSON.stringify(message);

      this.clients.forEach((client, clientId) => {
        if (client.ws.readyState === 1) {
          try {
            client.ws.send(messageString);
          } catch (error) {
            console.error(
              `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É ${clientId}:`,
              error
            );
          }
        }
      });
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º:`,
        error
      );
    }
  }

  /**
   * –¢—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç pong —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–∏—Ä–∂–∏ –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º
   * @param exchangeName –ù–∞–∑–≤–∞–Ω–∏–µ –±–∏—Ä–∂–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "gateio", "binance")
   * @param pongData –î–∞–Ω–Ω—ã–µ pong —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–∏—Ä–∂–∏
   */
  public broadcastExchangePong(exchangeName: string, pongData: any) {
    try {
      const message = {
        type: "exchange:pong",
        exchange: exchangeName,
        data: pongData,
        timestamp: Date.now(),
        source: "exchange",
      };

      const messageString = JSON.stringify(message);

      console.log(
        `üèì [${new Date().toISOString()}] –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è pong –æ—Ç –±–∏—Ä–∂–∏ ${exchangeName} –∫–ª–∏–µ–Ω—Ç–∞–º...`
      );

      this.clients.forEach((client, clientId) => {
        if (client.ws.readyState === 1) {
          try {
            client.ws.send(messageString);
            console.log(
              `üì§ [${new Date().toISOString()}] Pong –æ—Ç ${exchangeName} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É ${clientId}`
            );
          } catch (error) {
            console.error(
              `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ pong –∫–ª–∏–µ–Ω—Ç—É ${clientId}:`,
              error
            );
          }
        }
      });

      console.log(
        `‚úÖ [${new Date().toISOString()}] Pong –æ—Ç ${exchangeName} —Ç—Ä–∞–Ω—Å–ª–∏—Ä–æ–≤–∞–Ω ${
          this.clients.size
        } –∫–ª–∏–µ–Ω—Ç–∞–º`
      );
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ pong –æ—Ç –±–∏—Ä–∂–∏:`,
        error
      );
    }
  }

  /**
   * –¢—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –±–∞–ª–∞–Ω—Å–µ –æ—Ç –±–∏—Ä–∂–∏ –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º
   * @param balanceData –î–∞–Ω–Ω—ã–µ –±–∞–ª–∞–Ω—Å–∞
   */
  private broadcastExchangeBalance(balanceData: any) {
    try {
      const message = {
        type: "exchange:balance",
        exchange: balanceData.exchange || "unknown",
        data: balanceData,
        timestamp: Date.now(),
        source: "exchange",
      };

      const messageString = JSON.stringify(message);

      console.log(
        `üí∞ [${new Date().toISOString()}] –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞ –æ—Ç –±–∏—Ä–∂–∏ ${
          balanceData.exchange || "unknown"
        } –∫–ª–∏–µ–Ω—Ç–∞–º...`
      );

      this.clients.forEach((client, clientId) => {
        if (client.ws.readyState === 1) {
          try {
            client.ws.send(messageString);
            console.log(
              `üì§ [${new Date().toISOString()}] –ë–∞–ª–∞–Ω—Å –æ—Ç ${
                balanceData.exchange || "unknown"
              } –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É ${clientId}`
            );
          } catch (error) {
            console.error(
              `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–∞–ª–∞–Ω—Å–∞ –∫–ª–∏–µ–Ω—Ç—É ${clientId}:`,
              error
            );
          }
        }
      });

      console.log(
        `‚úÖ [${new Date().toISOString()}] –ë–∞–ª–∞–Ω—Å –æ—Ç ${
          balanceData.exchange || "unknown"
        } —Ç—Ä–∞–Ω—Å–ª–∏—Ä–æ–≤–∞–Ω ${this.clients.size} –∫–ª–∏–µ–Ω—Ç–∞–º`
      );
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ –±–∞–ª–∞–Ω—Å–∞ –æ—Ç –±–∏—Ä–∂–∏:`,
        error
      );
    }
  }

  async getStatus() {
    return {
      isRunning: this.isRunning,
      timestamp: Date.now(),
      activeClients: this.clients.size,
      systemStatus: this.systemStatus,
    };
  }

  async disconnect() {
    try {
      if (this.pingInterval) {
        clearInterval(this.pingInterval);
      }

      this.closeAllClientConnections();

      await this.redisClient.quit();

      console.log(
        `üîå [${new Date().toISOString()}] WebSocket Server —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∑–∞–∫—Ä—ã—Ç—ã`
      );
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π:`,
        error
      );
    }
  }

  private closeAllClientConnections() {
    try {
      this.clients.forEach((client) => {
        if (client.ws.readyState === 1) {
          client.ws.close(1001, "Server shutting down");
        }
      });

      this.clients.clear();
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π:`,
        error
      );
    }
  }

  public async shutdown() {
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ shutdown
    if (this.isShuttingDown) {
      console.log(
        `‚ö†Ô∏è  [${new Date().toISOString()}] –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫...`
      );
      return;
    }

    this.isShuttingDown = true;
    console.log(
      `üîÑ [${new Date().toISOString()}] –ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...`
    );

    try {
      // –û—Ç–º–µ–Ω—è–µ–º –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ Redis
      if (this.redisClient) {
        try {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–∫—Ä—ã—Ç–æ –ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É–∂–µ
          if (this.redisClient.isOpen) {
            await this.redisClient.unsubscribe();
            await this.redisClient.quit();
            console.log(
              `‚úÖ [${new Date().toISOString()}] Redis —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ`
            );
          } else {
            console.log(
              `‚ÑπÔ∏è  [${new Date().toISOString()}] Redis —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É–∂–µ –∑–∞–∫—Ä—ã—Ç–æ`
            );
          }
        } catch (redisError) {
          console.error(
            `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ Redis —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:`,
            redisError
          );
        }
      }

      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
      this.closeAllClientConnections();

      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ping-pong —Ç–∞–π–º–µ—Ä
      if (this.pingInterval) {
        clearInterval(this.pingInterval);
        this.pingInterval = null;
        console.log(
          `‚úÖ [${new Date().toISOString()}] Ping-Pong —Ç–∞–π–º–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω`
        );
      }

      // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebSocket —Å–µ—Ä–≤–µ—Ä
      if (this.wss) {
        this.wss.close((error) => {
          if (error) {
            console.error(
              `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ WebSocket —Å–µ—Ä–≤–µ—Ä–∞:`,
              error
            );
          } else {
            console.log(
              `‚úÖ [${new Date().toISOString()}] WebSocket —Å–µ—Ä–≤–µ—Ä –∑–∞–∫—Ä—ã—Ç`
            );
          }
        });
      }

      this.isRunning = false;
      console.log(
        `‚úÖ [${new Date().toISOString()}] –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ`
      );
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –ø—Ä–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏:`,
        error
      );
    }
  }
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–∏–≥–Ω–∞–ª–æ–≤
let wsServerInstance: WebSocketServerInstance | null = null;

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
async function main() {
  try {
    console.log(
      `üöÄ [${new Date().toISOString()}] –ó–∞–ø—É—Å–∫ WebSocket Server Instance D...`
    );

    wsServerInstance = new WebSocketServerInstance();
    await wsServerInstance.initialize();

    console.log(
      `üéØ [${new Date().toISOString()}] WebSocket Server Instance D –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!`
    );
    console.log(
      `üí° [${new Date().toISOString()}] –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤...`
    );
  } catch (error) {
    console.error(`‚ùå [${new Date().toISOString()}] –§–∞—Ç–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:`, error);
    process.exit(1);
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤
process.on("SIGINT", async () => {
  console.log(
    `\nüõë [${new Date().toISOString()}] –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª SIGINT. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...`
  );
  if (wsServerInstance) {
    await wsServerInstance.shutdown();
  }
  process.exit(0);
});

process.on("SIGTERM", async () => {
  console.log(
    `\nüõë [${new Date().toISOString()}] –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª SIGTERM. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...`
  );
  if (wsServerInstance) {
    await wsServerInstance.shutdown();
  }
  process.exit(0);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
process.on("uncaughtException", (error) => {
  console.error(
    `‚ùå [${new Date().toISOString()}] –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞:`,
    error
  );
  if (wsServerInstance) {
    wsServerInstance.shutdown().then(() => process.exit(1));
  } else {
    process.exit(1);
  }
});

process.on("unhandledRejection", (reason) => {
  console.error(
    `‚ùå [${new Date().toISOString()}] –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π rejection:`,
    reason
  );
  if (wsServerInstance) {
    wsServerInstance.shutdown().then(() => process.exit(1));
  } else {
    process.exit(1);
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ SIGHUP (–∑–∞–∫—Ä—ã—Ç–∏–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞)
process.on("SIGHUP", async () => {
  console.log(
    `\nüõë [${new Date().toISOString()}] –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª SIGHUP. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...`
  );
  if (wsServerInstance) {
    await wsServerInstance.shutdown();
  }
  process.exit(0);
});

// –¢–∞–π–º–∞—É—Ç –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–º–∞–∫—Å–∏–º—É–º 10 —Å–µ–∫—É–Ω–¥)
let shutdownTimeout: NodeJS.Timeout | null = null;

async function gracefulShutdown(signal: string) {
  console.log(
    `\nüõë [${new Date().toISOString()}] –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª ${signal}. –ù–∞—á–∞–ª–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...`
  );

  if (wsServerInstance) {
    try {
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
      shutdownTimeout = setTimeout(() => {
        console.error(
          `‚ùå [${new Date().toISOString()}] –¢–∞–π–º–∞—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (10—Å), –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ...`
        );
        process.exit(1);
      }, 10000);

      await wsServerInstance.shutdown();

      if (shutdownTimeout) {
        clearTimeout(shutdownTimeout);
      }
    } catch (error) {
      console.error(
        `‚ùå [${new Date().toISOString()}] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏:`,
        error
      );
      process.exit(1);
    }
  }

  process.exit(0);
}

// –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å —Ç–∞–π–º–∞—É—Ç–æ–º
process.on("SIGINT", () => gracefulShutdown("SIGINT"));
process.on("SIGTERM", () => gracefulShutdown("SIGTERM"));
process.on("SIGHUP", () => gracefulShutdown("SIGHUP"));

// –ó–∞–ø—É—Å–∫
main().catch((error) => {
  console.error(`‚ùå [${new Date().toISOString()}] –§–∞—Ç–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:`, error);
  gracefulShutdown("FAILURE");
});
